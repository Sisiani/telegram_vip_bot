import json
import asyncio
from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import Command

API_TOKEN = "8311865694:AAHrQDLSJcFKOztBj8X2PtMafk7U7AML0Uo"
ADMINS = [7374971382]  # Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ ØªÙ„Ú¯Ø±Ø§Ù… Ø®ÙˆØ¯Øª

bot = Bot(token=API_TOKEN)
dp = Dispatcher()

USERS_FILE = "users.json"

# ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ú©Ø§Ø±Ø¨Ø±
def save_user(user_id: int):
    try:
        with open(USERS_FILE, "r") as f:
            users = json.load(f)
    except FileNotFoundError:
        users = []

    if user_id not in users:
        users.append(user_id)
        with open(USERS_FILE, "w") as f:
            json.dump(users, f)


def get_users():
    try:
        with open(USERS_FILE, "r") as f:
            return json.load(f)
    except FileNotFoundError:
        return []


# Ù‡Ù†Ø¯Ù„Ø± Ø§Ø³ØªØ§Ø±Øª
@dp.message(Command("start"))
async def cmd_start(message: types.Message):
    save_user(message.from_user.id)
    await message.answer("Ø³Ù„Ø§Ù…! Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒ ğŸŒ¹")


# ÙÙ‚Ø· Ø§Ø¯Ù…ÛŒÙ† Ø¨ØªÙˆÙ†Ù‡ broadcast Ú©Ù†Ù‡
@dp.message(Command("broadcast"))
async def cmd_broadcast(message: types.Message):
    if message.from_user.id not in ADMINS:
        return await message.answer("âŒ Ø´Ù…Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯")

    await message.answer("Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯ ğŸ‘‡")

    @dp.message(F.chat.id == message.chat.id)  # ÙÙ‚Ø· Ù‡Ù…ÛŒÙ† Ø§Ø¯Ù…ÛŒÙ†
    async def get_broadcast(msg: types.Message):
        users = get_users()
        sent = 0
        for user_id in users:
            try:
                await bot.send_message(user_id, msg.text)
                sent += 1
                await asyncio.sleep(0.05)  # Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ø³Ù¾Ù…
            except:
                pass
        await msg.answer(f"âœ… Ù¾ÛŒØ§Ù… Ø¨Ø±Ø§ÛŒ {sent} Ù†ÙØ± Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.")
        dp.message.handlers.unregister(get_broadcast)  # ÙÙ‚Ø· ÛŒÚ©Ø¨Ø§Ø± Ø¨Ú¯ÛŒØ±Ù‡
